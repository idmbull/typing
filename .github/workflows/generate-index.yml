name: Auto Generate index.json

on:
  push:
    paths:
      - 'texts/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate index.json
        run: |
          mkdir -p texts
          echo "[" > index.json

          first=true

          # Lấy file txt và md, LOẠI file rác, LOẠI index.json
          while IFS= read -r -d '' file; do
            name="${file#texts/}"

            # encode JSON string an toàn
            esc=$(printf '%s' "$name" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read().rstrip("\n")))')

            if [ "$first" = true ]; then
              printf '  %s\n' "$esc" >> index.json
              first=false
            else
              printf ',\n  %s\n' "$esc" >> index.json
            fi

          done < <(
            find texts -maxdepth 1 -type f \
              \( -iname "*.txt" -o -iname "*.md" \) \
              ! -name "index.json" \
              ! -name "*.tmp" \
              ! -name "*.swp" \
              ! -name "*.bak" \
              ! -name "*~" \
              -print0 | sort -z
          )

          echo "]" >> index.json

      - name: Commit changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add index.json
          git commit -m "Auto update index.json" || echo "No changes"
          git push
